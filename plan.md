# 가치 편지 실행 계획서 (`plan.md`)

이 문서는 `README.md`의 기획 내용을 실제 개발 작업으로 옮기기 위한 실행 계획서입니다.  
목표는 **MVP를 빠르게 완성하고, 배포 가능한 상태까지 검증**하는 것입니다.

## 0) 개발 원칙

- App Router + TypeScript 기반으로 구현한다.
- 서버 상태 관리는 TanStack Query를 기본으로 한다.
- API는 Next.js Route Handlers를 사용한다.
- 인증/DB는 Firebase(Auth + Firestore)로 구성한다.
- 모든 주요 기능은 에러/로딩/빈 상태를 포함한다.
- 민감한 값은 서버/환경변수로 관리하고 클라이언트에 노출하지 않는다.

---

## 1) 범위 확정 (MVP Scope)

### 포함
- 구글 로그인
- 인트로 메시지 슬라이드(순차 노출)
- 8개 섹션 질문 답변 작성(문항당 1500자 제한)
- 섹션/단계 저장
- 상대 이메일 입력 후 제출
- 제출 후 전송 문구 + 최소 3초 대기 문구 전환
- 받은 편지 1회 알림
- 편지 상세에서 상대 답변(상단)/내 답변(하단) 비교

### 제외 (MVP 이후)
- 푸시 알림/이메일 발송 연동
- 다국어 지원
- 고급 통계/분석 대시보드
- 관리자 페이지

---

## 2) 작업 TODO (의존성 순서 기준)

## Phase 1. 프로젝트 초기화/기반 설정

### TODO
- [ ] Next.js(App Router, TypeScript) 프로젝트 생성
- [ ] Tailwind CSS 설정
- [ ] shadcn/ui 초기화 (Button/Input/Textarea/Card 우선)
- [ ] axios, @tanstack/react-query 설치/초기 설정
- [ ] 폴더 구조(FSD 기준) 초안 구성

### 산출물
- 실행 가능한 기본 앱
- 공통 Provider(QueryClientProvider 등) 적용

### 완료 기준(DoD)
- `npm run dev`에서 기본 페이지 렌더링
- Query Provider가 루트 레이아웃에 정상 연결

---

## Phase 2. Firebase 연동 및 인증

### TODO
- [ ] Firebase 프로젝트 준비 (Auth/Firestore 활성화)
- [ ] Google 로그인 구성
- [ ] Firebase client/admin 초기화 모듈 작성
- [ ] 로그인 상태 기반 라우트 접근 제어
- [ ] 사용자 기본 프로필(`users`) 저장 로직

### 산출물
- 로그인/로그아웃 동작
- 로그인 사용자 정보 조회 가능

### 완료 기준(DoD)
- 비로그인 시 작성/수신/상세 페이지 접근 제한
- 로그인 성공 시 사용자 문서 생성/갱신

---

## Phase 3. 도메인 모델/상수/타입 정의

### TODO
- [ ] 질문 데이터 상수화 (`entities/question/model/questions.ts`)
- [ ] Firestore 문서 타입 정의 (`users`, `letters`, `receipts`)
- [ ] 이메일 정규화 유틸(소문자/trim) 구현
- [ ] 공통 에러 타입/응답 타입 정의

### 산출물
- 타입 안정성을 갖춘 데이터 모델

### 완료 기준(DoD)
- 질문/답변/편지 타입이 UI/API 양쪽에서 재사용
- `any` 없이 주요 흐름 타입 추론 가능

---

## Phase 4. 인트로/작성 UI 구현

### TODO
- [ ] `/` 랜딩 페이지(서비스 카피 + 로그인 버튼)
- [ ] `/intro` 슬라이드 메시지 순차 노출 UI
- [ ] `/write` 질문 작성 페이지(섹션/문항 이동)
- [ ] 문항별 1500자 제한 + 글자수 카운터
- [ ] 다음 버튼 시 진행 상태 저장

### 산출물
- 사용자 입력 중심의 작성 플로우 완성

### 완료 기준(DoD)
- 인트로 문구 3개가 순서대로 노출
- 입력 제한 및 다음 단계 이동 정상 동작

---

## Phase 5. API/DB 저장 로직 구현

### TODO
- [ ] `POST /api/letters` (편지 생성/제출)
- [ ] `GET /api/letters/inbox` (내 이메일 기준 수신 조회)
- [ ] `GET /api/letters/[id]` (편지 상세 조회)
- [ ] `POST /api/letters/[id]/read` (최초 1회 알림 처리)
- [ ] API 입력값 검증(필수값/길이/권한)

### 산출물
- 서버리스 API 4종
- Firestore CRUD 로직

### 완료 기준(DoD)
- 작성->저장->조회 흐름이 API 기준으로 검증됨
- 권한 없는 접근은 401/403으로 차단

---

## Phase 6. 전송/대기/수신함/상세 화면

### TODO
- [ ] 제출 직후: `상대에게 가치 편지를 보내고 있어요` 표시
- [ ] 저장 완료 후 최소 3초 뒤: `상대의 편지를 기다리고 있어요` 전환
- [ ] `/inbox` 수신 목록 + 최초 1회 알림 문구 처리
- [ ] `/letters/[id]` 문항별 비교 뷰(상대 위, 나 아래)
- [ ] 로딩/빈 상태/에러 상태 UI

### 산출물
- 핵심 사용자 가치(편지 교환/열람) 구현 완료

### 완료 기준(DoD)
- 수신자가 편지 발견 후 읽기까지 막힘 없이 진행
- 동일 편지 알림 문구가 최초 1회만 동작

---

## Phase 7. 보안/성능/품질 점검

### TODO
- [ ] Firestore Security Rules 검토/적용
- [ ] Query key/staleTime/cacheTime 정책 정리
- [ ] 불필요한 리렌더링 점검 (필요 시 memoization 적용)
- [ ] 접근성(라벨, 포커스, 버튼 상태) 점검
- [ ] 기본 테스트 전략 수립(최소 핵심 플로우 수동 QA + 자동화 제안)

### 산출물
- 운영 전 점검 체크리스트 통과

### 완료 기준(DoD)
- 권한/보안 이슈 없이 핵심 시나리오 재현 가능
- 주요 화면에서 치명적 UX 결함 없음

---

## Phase 8. 배포 및 운영 준비

### TODO
- [ ] Vercel 프로젝트 연결
- [ ] 환경변수 설정(Firebase 키 등)
- [ ] 프로덕션 빌드/실행 검증
- [ ] README 배포 섹션 보강

### 산출물
- 외부 접근 가능한 MVP URL

### 완료 기준(DoD)
- 배포 URL에서 로그인/작성/수신/열람 전체 동작 확인

---

## 3) 화면별 체크리스트

## `/`
- [ ] 서비스 타이틀/설명 노출
- [ ] 구글 로그인 버튼

## `/intro`
- [ ] 3개 문장 순차 애니메이션
- [ ] 완료 후 시작 CTA 활성화

## `/write`
- [ ] 섹션 제목 + 질문 텍스트 영역
- [ ] 글자수(0~1500) 카운트
- [ ] 다음/이전 이동 및 저장
- [ ] 마지막에 상대 이메일 입력

## `/waiting`
- [ ] 전송 중 문구
- [ ] 저장 완료 후 최소 3초 대기 후 상태 변경

## `/inbox`
- [ ] 수신 편지 목록
- [ ] 최초 1회 알림 문구 + 읽어보기 버튼

## `/letters/[id]`
- [ ] 질문 단위 렌더링
- [ ] 상대 답변(상단), 내 답변(하단)

---

## 4) API 계약 초안

## `POST /api/letters`
- 요청:
  - `toEmail: string`
  - `answers: { sectionId: string; questionId: string; answerText: string }[]`
- 검증:
  - 로그인 사용자 필수
  - `toEmail` 형식/정규화
  - `answerText` 최대 1500자
- 응답:
  - `letterId`, `status`, `sentAt`

## `GET /api/letters/inbox`
- 조건:
  - 로그인 사용자 이메일과 `toEmail` 매칭
- 응답:
  - 편지 목록(최신순), `notified/seenAt` 포함

## `GET /api/letters/[id]`
- 조건:
  - 발신자 또는 수신자만 조회 가능
- 응답:
  - 편지 본문 + 내 답변 매칭 데이터

## `POST /api/letters/[id]/read`
- 동작:
  - 최초 알림 상태를 읽음으로 전환
- 응답:
  - `ok: true`

---

## 5) 리스크 및 대응

- 이메일 오입력:
  - 대응: 입력 정규화 + 기본 형식 검증 + 제출 전 확인 UX
- 중복 제출:
  - 대응: 제출 버튼 disable + idempotency 성격 처리
- 권한 누락:
  - 대응: API 체크 + Firestore Rules 이중 검증
- 데이터 누락:
  - 대응: 단계 저장 + 제출 전 최종 검증

---

## 6) 테스트 전략

## 수동 QA 시나리오 (필수)
- [ ] 로그인 -> 인트로 -> 작성 -> 제출 -> 대기 문구 전환
- [ ] A가 B 이메일로 작성 후, B 계정에서 수신 확인
- [ ] B가 읽기 클릭 시 비교 화면 정상 렌더
- [ ] 1500자 초과 입력 차단
- [ ] 비로그인 접근 차단

## 자동화 테스트 (권장)
- [ ] 유틸 테스트: 이메일 정규화, 입력 길이 검증
- [ ] API 테스트: 권한/유효성/성공 경로
- [ ] 핵심 컴포넌트 렌더 테스트(최소 범위)

---

## 7) 일정 제안 (4일 기준)

- Day 1: Phase 1~3 (세팅/인증/모델)
- Day 2: Phase 4~5 (작성 UI + API 저장)
- Day 3: Phase 6 (수신함/상세/대기 흐름)
- Day 4: Phase 7~8 (점검/배포/문서 보강)

---

## 8) 진행 관리 규칙

- 각 Phase 시작 전: 목표/의존성 확인
- 각 Phase 종료 후: DoD 체크 후 다음 단계 진행
- 블로커 발생 시: 원인/영향/대안 3가지를 기록하고 결정
- 큰 변경 시: README 업데이트 필요 여부를 함께 판단

---

## 9) 최종 완료 기준 (Release Criteria)

- 로그인 사용자 기준으로 작성/전송/수신/열람의 end-to-end가 동작한다.
- 권한 없는 사용자는 편지 데이터에 접근할 수 없다.
- 사용자가 체감하는 핵심 UX 문구 및 순서가 요구사항과 일치한다.
- 배포 URL에서 재현 가능한 상태로 문서화되어 있다.
